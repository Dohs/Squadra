version: '3.8'
services:
  # Service de l'application WebApi
  squadra-webapi:
    build:
      context: .
      dockerfile: Dockerfile
      target: squadra-webapi
    ports:
      - "8080:8080" # Port HTTP
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=squadra-db;Port=5432;Database=Squadra;Username=postgres;Password=root
    depends_on:
      - squadra-db
    networks:
      - squadra-network

  # Service de l'application Squadra.UI (Blazor WebAssembly)
  squadra-ui:
    build:
      context: .
      dockerfile: Dockerfile
      target: squadra-ui
    ports:
      - "8081:80" # Mappe le port externe 8081 au port interne 80 (Nginx)
    depends_on:
      - squadra-webapi
    networks:
      - squadra-network

  # Service de la base de données PostgreSQL
  squadra-db:
    image: postgres:15
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=Squadra
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=root
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - squadra-network

# Volumes pour la persistance des données
volumes:
  postgres_data:

# Réseau pour la communication entre les services
networks:
  squadra-network:
    driver: bridge